# 8. 開発ワークフローガイド

このドキュメントでは、`ecsite-v2` プロジェクトにおける標準的な開発ワークフローについて説明します。一貫したプロセスに従うことで、コードの品質を維持し、チームでの共同作業を円滑に進めることができます。

## Git Flow

当プロジェクトでは、Git Flowに基づいたブランチ戦略を採用しています。

### 主要ブランチ

*   **`main`:**
    *   常にリリース可能な安定した状態を保つブランチ。
    *   直接コミットすることは禁止されています。
    *   `release` ブランチまたは `hotfix` ブランチからのみマージされます。
*   **`develop`:**
    *   次のリリースに向けた開発の統合ブランチ。
    *   比較的安定していますが、`main` ほどではありません。
    *   `feature` ブランチからマージされます。
    *   `release` ブランチは `develop` から分岐します。

### サポートブランチ

*   **`feature/<feature-name>`:**
    *   新しい機能の開発を行うためのブランチ。
    *   `develop` ブランチから分岐します。
    *   機能開発が完了したら、`develop` ブランチに対してPull Requestを作成します。
    *   命名規則: `feature/issue-<issue番号>-short-description` (例: `feature/issue-123-add-user-profile`)
*   **`release/<release-version>`:**
    *   リリースの準備を行うためのブランチ（リリース前の最終調整、バグ修正、ドキュメント更新など）。
    *   `develop` ブランチから分岐します。
    *   リリース準備が完了したら、`main` ブランチと `develop` ブランチの両方にマージされます。
    *   命名規則: `release/v1.2.0`
*   **`hotfix/<hotfix-name>`:**
    *   リリース済みの `main` ブランチに対する緊急のバグ修正を行うためのブランチ。
    *   `main` ブランチから分岐します。
    *   修正が完了したら、`main` ブランチと `develop` ブランチの両方にマージされます。
    *   命名規則: `hotfix/fix-critical-login-bug`

### 基本的な開発フロー (新機能開発)

1.  **`develop` ブランチを最新化:**
    ```bash
    git checkout develop
    git pull origin develop
    ```
2.  **`feature` ブランチを作成:**
    ```bash
    git checkout -b feature/issue-XXX-your-feature-name develop
    ```
3.  **コーディングとコミット:**
    *   機能開発を進め、適切な粒度でコミットします。コミットメッセージは後述の規約に従ってください。
    *   ```bash
        git add .
        git commit -m "feat: Add user profile page"
        ```
4.  **`feature` ブランチをリモートにプッシュ:**
    ```bash
    git push origin feature/issue-XXX-your-feature-name
    ```
5.  **Pull Request (PR) の作成:**
    *   GitHubなどのリポジトリホスティングサービス上で、`feature/issue-XXX` から `develop` へのPull Requestを作成します。
    *   PRのテンプレートに従い、変更内容、理由、テスト内容などを記述します。
6.  **コードレビュー:**
    *   レビュワーを指名し、レビューを依頼します。
    *   レビューでの指摘事項に対応し、必要に応じて追加コミットを行います。
7.  **PRのマージ:**
    *   レビューで承認されたら、PRを `develop` ブランチにマージします。（通常はリポジトリホスティングサービスの機能を使用）
8.  **ローカルブランチの削除 (任意):**
    ```bash
    git checkout develop
    git branch -d feature/issue-XXX-your-feature-name
    ```

## コミット前の自動チェック (Lefthook)

当プロジェクトでは、コミット前にコードの品質を自動的にチェックし、整形するために [Lefthook](https://github.com/evilmartians/lefthook) を使用しています。

*   **設定ファイル:** プロジェクトルートの `lefthook.yml` でフックの設定が行われています。
*   **`pre-commit` フック:** 現在、コミット前に以下の処理が自動実行されます。
    *   **Java コードの整形:** Spotless Gradle プラグイン (`./gradlew spotlessApply`) を使用して、Java ソースコードのフォーマットを自動的に修正します。
*   **動作:** `git commit` を実行すると、Lefthook が `pre-commit` フックをトリガーし、設定されたコマンドを実行します。整形によってファイルが変更された場合、その変更をステージングに追加し直してからコミットする必要があります。
    ```bash
    # (整形によりファイルが変更された場合)
    git add .
    git commit --amend --no-edit # または再度コミットメッセージを入力
    ```
*   **スキップ:** 一時的にフックをスキップしたい場合は、`--no-verify` オプションを使用します (非推奨)。
    ```bash
    git commit -m "..." --no-verify
    ```

Lefthook により、コーディングスタイルの一貫性が保たれ、レビュープロセスでのフォーマットに関する指摘を減らすことができます。

## コミットメッセージ規約

### コミットメッセージの例

---

subject format: '{type}: {emoji}{subject}'
body format: '{body}'
maxMessageLength: 64
minMessageLength: 3

■ type

1. feat

   - 説明: ユーザー向けの新機能実装時に使用（例：新しい画面やAPIの追加など）。
   - emoji: 🎸

2. fix

   - 説明: バグ修正時に使用（例：NullPointer例外、ログイン問題の修正など）。
   - emoji: 🐛

3. docs

   - 説明: ドキュメントのみを変更する場合に使用（例：READMEの更新、ガイドの作成など）。
   - emoji: ✏️

4. style

   - 説明: 機能に影響を与えないコード変更時に使用（例：フォーマット、空白、セミコロンなど）。
   - emoji: 💄

5. chore

   - 説明: 本番コードに影響を与えないビルドシステム、開発環境の更新、ライブラリのアップグレードなどのタスクに使用。
   - emoji: 🤖

6. perf

   - 説明: パフォーマンス関連の改善時に使用（例：クエリの最適化など）。
   - emoji: ⚡️

7. refactor

   - 説明: 挙動を変更せずにコードをリファクタリングする場合に使用。
   - emoji: 💡

8. test

   - 説明: テストの追加や修正時に使用（例：ユニットテスト、E2Eテストなど）。
   - emoji: 💍

9. release

   - 説明: バージョンリリース関連のコミットに使用。
   - emoji: 🏹

10. ci
    - 説明: CI/CD設定関連の変更時に使用（例：GitHub Actions設定の追加など）。
    - emoji: 🎡

bodyには以下の情報を含めることができます：

- 変更の目的
- 変更の影響範囲
- 変更の詳細
- 変更の理由

---

■ ワークフロー

1. **提供されたコミット内容を分析し**、最も適切なタイプを選択します。
2. **件名**を決定します（64文字以内で簡潔に）。
3. 必要に応じて、`body`として詳細を追加します（任意）。
4. コミットメッセージを`{type}: {emoji}{subject}`形式で最初の行に出力します。
   bodyを含める場合は、改行後に追加します。

---

■ 使用例

- 変更内容: ログイン中のエラーを引き起こすバグを修正し、セキュリティログの処理をクリーンアップしました。

  - 最適なタイプ: fix
  - 件名: 「ログインエラーの修正とセキュリティログのクリーンアップ」

  出力:

  ```
  fix: 🐛ログインエラーの修正とセキュリティログのクリーンアップ
  ```

**フォーマット:**

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

*   **`<type>`:** コミットの種類を示す (必須)。
    *   `feat`: 新機能の追加
    *   `fix`: バグ修正
    *   `docs`: ドキュメントのみの変更
    *   `style`: コードスタイルに関する変更 (フォーマット、セミコロンなど)
    *   `refactor`: リファクタリング (機能変更やバグ修正を含まないコード変更)
    *   `perf`: パフォーマンス改善
    *   `test`: テストコードの追加・修正
    *   `build`: ビルドシステムや外部依存関係に関する変更 (Gradle, npmなど)
    *   `ci`: CI設定やスクリプトに関する変更
    *   `chore`: 上記いずれにも当てはまらない雑多な変更 (依存関係更新など)
*   **`[optional scope]`:** コミットが影響する範囲を示す (任意)。例: `account`, `api`, `db`
*   **`<description>`:** 変更内容の簡潔な説明 (必須)。現在形・命令形で記述し、大文字で始めない。ピリオドで終えない。
*   **`[optional body]`:** 変更の詳細な説明 (任意)。変更の理由や背景、以前の動作との違いなどを記述。
*   **`[optional footer(s)]`:** 関連するIssue番号などを記述 (任意)。例: `Fixes #123`, `Refs #456`

**良い例:**

```
feat(auth): add password reset functionality

Implement the password reset flow using email verification.
Users can now request a password reset link via their registered email.

Fixes #123
```

**悪い例:**

```
fix bug
```
```
updated stuff
```

## Pull Request (PR)

*   **目的:** コード変更を `develop` や `main` ブランチにマージする前に、レビューと議論を行うための仕組みです。
*   **作成:** GitHubなどのプラットフォームで、`feature` ブランチから `develop` へ、または `release`/`hotfix` ブランチから `main`/`develop` へのPRを作成します。
*   **テンプレート:** PR作成時には、用意されたテンプレートに従って以下の情報を記述してください。
    *   **変更の概要:** 何を変更したのか簡潔に。
    *   **変更の理由:** なぜこの変更が必要なのか。背景や目的。
    *   **関連Issue:** 関連するIssueがあればリンク (`Fixes #XXX`, `Refs #XXX`)。
    *   **変更内容の詳細:** 具体的な変更点、技術的な判断など。
    *   **テスト内容:** どのようにテストしたか（単体テスト、結合テスト、手動確認など）。
    *   **レビュー依頼事項:** 特に見てほしい点、懸念点など。
    *   **スクリーンショット/動画:** UI変更がある場合は添付。
*   **WIP (Work In Progress):** 開発途中のコードについて意見が欲しい場合は、タイトルに `[WIP]` を付けてPRを作成し、早期にフィードバックを求めることができます。マージ準備が整うまで、マージ不可の状態にしておきます。

## コードレビュー

*   **目的:** コードの品質向上、知識共有、バグの早期発見。
*   **依頼:** PR作成後、適切なレビュワー（通常はチームメンバー）を指名してレビューを依頼します。
*   **レビュワーの観点:**
    *   **設計:** 要件を満たしているか、拡張性・保守性は考慮されているか。
    *   **ロジック:** 正しく動作するか、エッジケースは考慮されているか。
    *   **可読性:** コードは理解しやすいか、命名は適切か。
    *   **テスト:** 十分なテストが書かれているか、テストは適切か。
    *   **規約:** コーディング規約に従っているか。
    *   **パフォーマンス:** 非効率な処理はないか。
    *   **セキュリティ:** 脆弱性はないか。
*   **コメント:**
    *   具体的かつ建設的なコメントを心がけます。問題点を指摘するだけでなく、改善案も提示できると良いでしょう。
    *   敬意を持ってコミュニケーションをとります。
    *   LGTM (Looks Good To Me) だけではなく、なぜ良いと思ったのか具体的に記述することも推奨されます。
*   **対応:**
    *   レビュワーからのコメントに感謝し、指摘事項に対応します。
    *   修正が必要な場合は追加コミットを行い、PRにプッシュします。
    *   コメントに対して質問や反論がある場合は、PR上で丁寧に議論します。
*   **承認とマージ:**
    *   レビュワーから承認 (Approve) を得られたら、PRをマージします。マージは通常、PR作成者が行いますが、プロジェクトのルールに従ってください。

## CI/CD (継続的インテグレーション/継続的デリバリー)

*   **概要:** (もしCI/CDパイプラインが設定されている場合) PR作成時や `develop`/`main` ブランチへのマージ時に、自動的にビルド、テスト、静的解析などが実行されます。
*   **設定:** CI/CDの設定ファイル（例: `.github/workflows/ci.yml`）で定義されています。
*   **確認:** CIの実行結果（成功/失敗）をPR上で確認し、失敗した場合は原因を調査して修正します。
*   **デプロイ:** (もしCDが設定されている場合) 特定のブランチ（例: `main`）へのマージをトリガーに、ステージング環境や本番環境への自動デプロイが行われる場合があります。

このワークフローに従うことで、スムーズで高品質な開発を進めることができます。不明な点があれば、チームメンバーに確認してください。
