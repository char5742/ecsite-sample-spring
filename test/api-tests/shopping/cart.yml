# ショッピングカート API テスト
desc: カートの取得・作成機能のテスト

# ベースURL
host: {{ env.API_BASE_URL | default("http://localhost:8080") }}

# タグ
labels:
  - shopping
  - cart

# テスト前準備（アカウント作成、ログイン）
runners:
  # テストユーザーを作成
  - req:
      method: POST
      path: /api/authentication/signup
      headers:
        Content-Type: application/json
      body:
        email: "test-cart-{{ now | unixtime }}@example.com"
        password: "Test123!"
    test:
      status: 200
  
  # ログインしてトークンを取得
  - req:
      method: POST
      path: /api/authentication/login
      headers:
        Content-Type: application/json
      body:
        email: "test-cart-{{ now | unixtime }}@example.com"
        password: "Test123!"
    test:
      status: 200
    bind:
      authToken: body.token
      # 実際の実装では JWT から accountId を取得する必要がある
      accountId: "test-account-{{ now | unixtime }}"

# テストステップ
steps:
  # 正常系: カート取得/作成
  - desc: 初回カート取得（新規作成される）
    req:
      method: GET
      path: /api/carts/{{ runners[1].accountId }}
      headers:
        Authorization: "Bearer {{ runners[1].authToken }}"
    test:
      status: 200
      body:
        cartId: /^.+$/  # カートIDが存在することを確認
        accountId: "{{ runners[1].accountId }}"
        items: []  # 最初は空のカート
        total: 0
        createdAt: /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/  # 日時形式の確認
        updatedAt: /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/
    bind:
      cartId: body.cartId

  # 正常系: 既存カート取得
  - desc: 2回目のカート取得（既存のカートが返る）
    req:
      method: GET
      path: /api/carts/{{ runners[1].accountId }}
      headers:
        Authorization: "Bearer {{ runners[1].authToken }}"
    test:
      status: 200
      body:
        cartId: "{{ steps[0].cartId }}"  # 同じカートIDが返ることを確認
        accountId: "{{ runners[1].accountId }}"
        items: []
        total: 0

  # 異常系: 認証なしでのカート取得
  - desc: 認証トークンなしでのカート取得
    req:
      method: GET
      path: /api/carts/{{ runners[1].accountId }}
    test:
      status: 401  # Unauthorized

  # 異常系: 無効なアカウントID
  - desc: 無効な形式のアカウントIDでカート取得
    req:
      method: GET
      path: /api/carts/invalid-account-id
      headers:
        Authorization: "Bearer {{ runners[1].authToken }}"
    test:
      status: 400  # Bad Request

  # 異常系: 別のアカウントのカートにアクセス
  - desc: 他のアカウントのカートにアクセス（権限チェック）
    req:
      method: GET
      path: /api/carts/other-account-id
      headers:
        Authorization: "Bearer {{ runners[1].authToken }}"
    test:
      status: 403  # Forbidden または 400 Bad Request（実装による）