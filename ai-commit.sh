#!/usr/bin/env bash
set -euo pipefail

# 1. ã‚¹ãƒ†ãƒ¼ã‚¸æ¸ˆã¿å¤‰æ›´ã®ãƒã‚§ãƒƒã‚¯
if git diff --cached --quiet; then
  echo "âš ï¸  ã‚¹ãƒ†ãƒ¼ã‚¸æ¸ˆã¿ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãš git add ã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi

# 2. diff ã‚’åˆ¶é™ä»˜ãã§å–å¾—
diff_text=$(git diff --cached | head -c 15000)

# 3. Claude ã«æ¸¡ã™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
prompt=$(cat <<'EOF'
## ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„

å½“ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä»¥ä¸‹ã®å½¢å¼ã«åŸºã¥ã„ãŸã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®è¦ç´„ã¯åŠ¹æœçš„ãªå±¥æ­´ç®¡ç†ã¨ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã®ãŸã‚ã«é‡è¦ã§ã™ã€‚

**ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:**
```
{type}: {emoji}{subject}

[optional body]
```

### ã‚¿ã‚¤ãƒ—ã¨çµµæ–‡å­—

| ã‚¿ã‚¤ãƒ— | èª¬æ˜ | çµµæ–‡å­— | ä½¿ç”¨ä¾‹ |
|--------|------|--------|--------|
| `feat` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®æ–°æ©Ÿèƒ½å®Ÿè£… | ğŸ¸ | `feat: ğŸ¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ` |
| `fix` | ãƒã‚°ä¿®æ­£ | ğŸ› | `fix: ğŸ› ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®NullPointerExceptionã‚’ä¿®æ­£` |
| `docs` | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–° | âœï¸ | `docs: âœï¸ READMEã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’æ›´æ–°` |
| `style` | ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ (æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—) | ğŸ’„ | `style: ğŸ’„ ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’ä¿®æ­£` |
| `refactor` | æ©Ÿèƒ½å¤‰æ›´ã®ãªã„ã‚³ãƒ¼ãƒ‰æ”¹å–„ | ğŸ’¡ | `refactor: ğŸ’¡ èªè¨¼å‡¦ç†ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°` |
| `perf` | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ | âš¡ï¸ | `perf: âš¡ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–` |
| `test` | ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ä¿®æ­£ | ğŸ’ | `test: ğŸ’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²APIã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ` |
| `build` | ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãƒ»ä¾å­˜é–¢ä¿‚å¤‰æ›´ | ğŸ—ï¸ | `build: ğŸ—ï¸ Spring Bootã‚’3.1.2ã«æ›´æ–°` |
| `ci` | CIè¨­å®šå¤‰æ›´ | ğŸ¡ | `ci: ğŸ¡ GitHub Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ”¹å–„` |
| `chore` | ãã®ä»–ã®å¤‰æ›´ | ğŸ¤– | `chore: ğŸ¤– .gitignoreã‚’æ›´æ–°` |
| `release` | ãƒªãƒªãƒ¼ã‚¹é–¢é€£ | ğŸ¹ | `release: ğŸ¹ v1.0.0ã‚’ãƒªãƒªãƒ¼ã‚¹` |

### ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°

* **ã‚¿ã‚¤ãƒ— (type):** å¤‰æ›´ã®ç¨®é¡ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (å¿…é ˆ)ã€‚ä¸Šè¡¨ã®ã„ãšã‚Œã‹ã‚’ä½¿ç”¨ã€‚
* **çµµæ–‡å­— (emoji):** å¤‰æ›´ã®ç¨®é¡ã‚’è¦–è¦šçš„ã«ç¤ºã™ (å¿…é ˆ)ã€‚ä¸Šè¡¨ã®ã„ãšã‚Œã‹ã‚’ä½¿ç”¨ã€‚
* **ä»¶å (subject):** å¤‰æ›´å†…å®¹ã®ç°¡æ½”ãªèª¬æ˜ (å¿…é ˆ)
  * 64æ–‡å­—ä»¥å†…ã‚’æ¨å¥¨
  * ç¾åœ¨å½¢ãƒ»å‘½ä»¤å½¢ã§è¨˜è¿°
  * å¤§æ–‡å­—ã§å§‹ã‚ãšã€ãƒ”ãƒªã‚ªãƒ‰ã§çµ‚ãˆãªã„
* **æœ¬æ–‡ (body):** å¤‰æ›´ã®è©³ç´°ãªèª¬æ˜ (ä»»æ„)
  * å¤‰æ›´ã®ç†ç”±ã€èƒŒæ™¯ã€ä»¥å‰ã®å‹•ä½œã¨ã®é•ã„ãªã©
  * ç©ºè¡Œã‚’æŒŸã‚“ã§è¨˜è¿°

### ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹

```
feat: ğŸ¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†æ©Ÿèƒ½ã‚’è¿½åŠ 

- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…
- é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨ãƒªãƒã‚¸ãƒˆãƒªãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°

Refs #123
```

```
fix: ğŸ› ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®NullPointerExceptionã‚’ä¿®æ­£

- ç‰¹å®šã®æ¡ä»¶ä¸‹ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒå–å¾—ã§ããšã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãŸå•é¡Œã‚’ä¿®æ­£
- ãƒªãƒã‚¸ãƒˆãƒªå±¤ã§ã®Optionalã®æ‰±ã„ã‚’è¦‹ç›´ã—
```

ä»¥ä¸‹ã® Git diff ã‹ã‚‰ã€è¦ç´„ã«ãã£ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ãã®ã¾ã¾commit ã™ã‚‹ã®ã§ã€ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
EOF
)

# 4. Claude ã«é€ã‚Šè¾¼ã‚€
generated_msg=$(
  { printf "%s\n\n%s\n" "$prompt" "$diff_text"; } \
  | claude -p --print --output-format text
)

# 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
echo -e "\nğŸ“ Claude ã®ææ¡ˆ: \n\033[1m${generated_msg}\033[0m"
read -rp "â†‘ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ [y/N]: " answer
if [[ $answer =~ ^[Yy]$ ]]; then
  git commit -m "$generated_msg"
  echo "âœ… ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸï¼"
else
  echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«æ®‹ã—ã¦ãŠãã­ğŸ«¶"
  command -v pbcopy &>/dev/null && printf "%s" "$generated_msg" | pbcopy
fi
